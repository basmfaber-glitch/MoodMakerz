<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>MoodMarket</title>
<meta name="theme-color" content="#0b1020">
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#0b1020;
    --border: rgba(255,255,255,0.10);
    --text:#eef2ff;
    --muted:#a6b0cf;
    --accent:#7c83ff;
    --accent2:#2dd4bf;
    --danger:#fb7185;
    --shadow: 0 18px 44px rgba(0,0,0,0.35);
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 500px at 10% -10%, rgba(124,131,255,0.16), transparent 55%),
      radial-gradient(700px 420px at 90% 0%, rgba(45,212,191,0.12), transparent 60%),
      var(--bg);
  }
  .container{ max-width: 1080px; margin:0 auto; padding: 18px 16px 80px; }
  header{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; padding: 10px 0; }
  .brand h1{ margin:0; font-size: clamp(18px, 2.2vw, 22px); letter-spacing:-0.02em; font-weight: 750; }
  .brand p{ margin:6px 0 0; font-size: 13px; color: var(--muted); line-height: 1.35; max-width: 62ch; }
  .toplinks{ display:flex; gap:10px; align-items:center; }
  .pill{
    color: var(--text);
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    user-select:none;
  }
  .pill:hover{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.14); }
  .pill:active{ transform: translateY(1px); }
  .pill.primary{
    border: none;
    color:#0b1020;
    background: linear-gradient(90deg, rgba(124,131,255,0.85), rgba(45,212,191,0.75));
    font-weight: 750;
  }
  .pill.primary:hover{ filter: brightness(0.98); }

  .moods-wrap{
    margin-top: 6px;
    padding: 10px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.035);
    border-radius: 16px;
  }
  .moods{
    display:flex;
    gap:8px;
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
    padding: 2px;
  }
  .moods::-webkit-scrollbar{ height: 8px; }
  .moods::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.10); border-radius: 999px; }
  .mood{
    flex:0 0 auto;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:center;
    gap:8px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--text);
    font-size: 13px;
    line-height: 1;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .mood:hover{ background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.12); }
  .mood:active{ transform: scale(0.98); }
  .mood .emoji{ font-size: 14px; opacity: 0.95; }
  .mood.active{ border-color: rgba(124,131,255,0.50); background: rgba(124,131,255,0.10); }

  .feed-head{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:12px;
    margin-top: 16px;
  }
  .feed-head h2{ margin:0; font-size: 14px; font-weight: 800; letter-spacing: 0.01em; }
  .feed-head .hint{ margin:0; font-size: 12.5px; color: var(--muted); }

  .feed{
    margin-top: 12px;
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
  }
  .card{ grid-column: span 4; }
  @media (max-width: 900px){ .card{ grid-column: span 6; } }
  @media (max-width: 560px){ .card{ grid-column: span 12; } }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border: 1px solid rgba(255,255,255,0.09);
    border-radius: 18px;
    overflow:hidden;
    box-shadow: var(--shadow);
  }

  .thumb{
    width:100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    display:block;
    background: rgba(255,255,255,0.04);
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .card-inner{ padding: 12px 12px 14px; }

  .badge{
    display:inline-flex;
    font-size: 11px;
    font-weight: 750;
    color: rgba(255,255,255,0.92);
    background: rgba(124,131,255,0.14);
    border: 1px solid rgba(124,131,255,0.25);
    padding: 4px 8px;
    border-radius: 999px;
  }

  .card h3{ margin: 10px 0 6px; font-size: 14px; letter-spacing:-0.01em; }
  .card p{ margin: 0 0 10px; font-size: 12.5px; color: var(--muted); line-height: 1.35; }

  .actions{ display:flex; gap:10px; align-items:center; }

  .buy{
    flex:1;
    padding: 10px 12px;
    border: none;
    border-radius: 12px;
    cursor:pointer;
    font-weight: 800;
    font-size: 13px;
    color: #0b1020;
    background: linear-gradient(90deg, rgba(124,131,255,0.85), rgba(45,212,191,0.75));
  }
  .buy:hover{ filter: brightness(0.98); }
  .buy:active{ transform: translateY(1px); }

  .iconbtn{
    width: 38px;
    height: 38px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.9);
    cursor:pointer;
    display:grid;
    place-items:center;
  }
  .iconbtn:hover{ background: rgba(255,255,255,0.07); }
  .iconbtn:active{ transform: translateY(1px); }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 16px;
    transform: translateX(-50%);
    background: rgba(2,6,23,0.75);
    border: 1px solid rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    color: rgba(255,255,255,0.92);
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 12px;
    display:none;
    max-width: calc(100% - 24px);
    box-shadow: 0 14px 34px rgba(0,0,0,0.45);
    z-index: 50;
  }

  /* Favorites modal */
  .modalBackdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; z-index: 60; }
  .modal{
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    width: min(920px, calc(100% - 24px));
    background: rgba(18,23,42,0.92);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    box-shadow: 0 26px 80px rgba(0,0,0,0.6);
    display:none;
    z-index: 61;
  }
  .modalHeader{
    padding: 12px 12px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom: 1px solid rgba(255,255,255,0.10);
  }
  .modalHeader h3{ margin:0; font-size: 14px; letter-spacing: -0.01em; }
  .modalHeader .sub{ margin: 4px 0 0; font-size: 12px; color: var(--muted); }
  .modalBody{ padding: 12px; }
  .favGrid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
  }
  .favCard{ grid-column: span 4; }
  @media (max-width: 900px){ .favCard{ grid-column: span 6; } }
  @media (max-width: 560px){ .favCard{ grid-column: span 12; } }
  .favCard{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border: 1px solid rgba(255,255,255,0.09);
    border-radius: 16px;
    overflow:hidden;
  }
  .favInner{ padding: 12px; }
  .favTitle{ font-weight: 800; font-size: 13.5px; margin: 0 0 6px; }
  .favDesc{ margin: 0 0 10px; color: var(--muted); font-size: 12.5px; line-height: 1.35; }
  .danger{ background: rgba(251,113,133,0.14) !important; border: 1px solid rgba(251,113,133,0.30) !important; }
  .modalFooter{
    padding: 10px 12px 12px;
    border-top: 1px solid rgba(255,255,255,0.10);
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    color: var(--muted);
    font-size: 12px;
  }

  footer{ margin-top: 14px; color: rgba(255,255,255,0.45); font-size: 12px; text-align:center; }
</style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>MoodMarket</h1>
        <p>Each mood has a fixed list of 50 items. Shuffle cycles through without duplicates on the same page.</p>
      </div>
      <div class="toplinks">
        <button class="pill primary" id="shuffleBtn" type="button">Shuffle suggestions</button>
        <button class="pill" id="openFavorites" type="button">Favorites <span id="favCount" style="opacity:.85">(0)</span></button>
      </div>
    </header>

    <div class="moods-wrap">
      <div class="moods" id="moods">
        <div class="mood active" data-mood="Stressed"><span class="emoji">üò´</span>Stressed</div>
        <div class="mood" data-mood="Happy"><span class="emoji">üòÉ</span>Happy</div>
        <div class="mood" data-mood="Energetic"><span class="emoji">‚ö°</span>Energetic</div>
        <div class="mood" data-mood="Creative"><span class="emoji">üé®</span>Creative</div>
        <div class="mood" data-mood="Tired"><span class="emoji">üò¥</span>Tired</div>
      </div>
    </div>

    <div class="feed-head">
      <h2 id="feedTitle">Recommended for: Stressed</h2>
      <p class="hint">Click the same mood again or press Shuffle for a new batch.</p>
    </div>

    <div class="feed" id="feed"></div>

    <footer>
      MoodMarket ¬© Affiliate links may earn a commission. Fill affiliate_links.csv to map each item to a real URL.
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="modalBackdrop"></div>
  <div class="modal" id="favModal" role="dialog" aria-modal="true" aria-label="Favorites">
    <div class="modalHeader">
      <div>
        <h3>Favorites</h3>
        <div class="sub">Saved items are stored on this device (localStorage).</div>
      </div>
      <button class="pill" id="closeFavorites" type="button">Close</button>
    </div>
    <div class="modalBody">
      <div class="favGrid" id="favGrid"></div>
    </div>
    <div class="modalFooter">
      <div id="favFooterText">0 saved</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="pill danger" id="clearFavorites" type="button">Clear all</button>
      </div>
    </div>
  </div>

<script>
  /***********************
   * 1) Catalog (50 fixed items per mood)
   * 2) No duplicates on page (batch is unique)
   * 3) Cycles through all 50 before repeating
   * 4) Images: uses Unsplash Source with query (works without hosting images)
   ************************/

  const CARDS_PER_REFRESH = 9;

  // Affiliate mapping placeholder:
  // For now we generate a predictable URL. Replace using affiliate_links.csv later.
  const AFFILIATE_BASE = "https://example.com?aff=YOURID&item=";

  const CATALOG = {
  "Stressed": [
    "Herbal Tea",
    "Breathing Timer",
    "Guided Meditation",
    "Aromatherapy Oil",
    "Weighted Blanket",
    "Stress Journal",
    "Noise-Reducing Earbuds",
    "Body Scan Audio",
    "Candle Set",
    "Sleep Mask",
    "Desk Zen Kit",
    "Calm Focus Music",
    "Neck Massager",
    "Room Spray",
    "Gentle Yoga Flow",
    "Mindful Coloring Book",
    "Stress Ball",
    "Short Walk Plan",
    "Bath Salts",
    "Relaxation Soundscape",
    "Herbal Tea \u2014 Chamomile",
    "Herbal Tea \u2014 Lavender",
    "Herbal Tea \u2014 Peppermint",
    "Herbal Tea \u2014 5-minute",
    "Herbal Tea \u2014 10-minute",
    "Herbal Tea \u2014 Beginner-friendly",
    "Herbal Tea \u2014 Travel size",
    "Herbal Tea \u2014 Budget pick",
    "Herbal Tea \u2014 Premium pick",
    "Herbal Tea \u2014 Night routine",
    "Breathing Timer \u2014 Chamomile",
    "Breathing Timer \u2014 Lavender",
    "Breathing Timer \u2014 Peppermint",
    "Breathing Timer \u2014 5-minute",
    "Breathing Timer \u2014 10-minute",
    "Breathing Timer \u2014 Beginner-friendly",
    "Breathing Timer \u2014 Travel size",
    "Breathing Timer \u2014 Budget pick",
    "Breathing Timer \u2014 Premium pick",
    "Breathing Timer \u2014 Night routine",
    "Guided Meditation \u2014 Chamomile",
    "Guided Meditation \u2014 Lavender",
    "Guided Meditation \u2014 Peppermint",
    "Guided Meditation \u2014 5-minute",
    "Guided Meditation \u2014 10-minute",
    "Guided Meditation \u2014 Beginner-friendly",
    "Guided Meditation \u2014 Travel size",
    "Guided Meditation \u2014 Budget pick",
    "Guided Meditation \u2014 Premium pick",
    "Guided Meditation \u2014 Night routine"
  ],
  "Happy": [
    "Instant Camera",
    "Mini Photo Printer",
    "Dance Playlist",
    "Fun Card Game",
    "Mocktail Kit",
    "Gratitude Journal",
    "Mini Adventure List",
    "Comedy Special",
    "Party Lights",
    "Photo Memory Book",
    "Friendship Activity Deck",
    "Cook-Together Recipe Kit",
    "Portable Speaker",
    "Craft Night Kit",
    "Movie Night Box",
    "Board Game Pick",
    "Funny Podcast",
    "Surprise Gift Idea",
    "Weekend Plan Generator",
    "Music Discovery Pack",
    "Instant Camera \u2014 For couples",
    "Instant Camera \u2014 For friends",
    "Instant Camera \u2014 Solo",
    "Instant Camera \u2014 Under $20",
    "Instant Camera \u2014 Premium",
    "Instant Camera \u2014 Outdoor",
    "Instant Camera \u2014 Indoor",
    "Instant Camera \u2014 15-minute",
    "Instant Camera \u2014 30-minute",
    "Instant Camera \u2014 Instant",
    "Mini Photo Printer \u2014 For couples",
    "Mini Photo Printer \u2014 For friends",
    "Mini Photo Printer \u2014 Solo",
    "Mini Photo Printer \u2014 Under $20",
    "Mini Photo Printer \u2014 Premium",
    "Mini Photo Printer \u2014 Outdoor",
    "Mini Photo Printer \u2014 Indoor",
    "Mini Photo Printer \u2014 15-minute",
    "Mini Photo Printer \u2014 30-minute",
    "Mini Photo Printer \u2014 Instant",
    "Dance Playlist \u2014 For couples",
    "Dance Playlist \u2014 For friends",
    "Dance Playlist \u2014 Solo",
    "Dance Playlist \u2014 Under $20",
    "Dance Playlist \u2014 Premium",
    "Dance Playlist \u2014 Outdoor",
    "Dance Playlist \u2014 Indoor",
    "Dance Playlist \u2014 15-minute",
    "Dance Playlist \u2014 30-minute",
    "Dance Playlist \u2014 Instant"
  ],
  "Energetic": [
    "HIIT Timer",
    "Jump Rope",
    "Resistance Bands",
    "Running Playlist",
    "Electrolyte Mix",
    "Protein Snack Box",
    "Mobility Routine",
    "Push-Up Challenge",
    "Dance Cardio",
    "Boxing Workout",
    "Cycling Plan",
    "Stretch + Strength Split",
    "Step Goal Plan",
    "Interval Training Guide",
    "5K Training Plan",
    "Core Routine",
    "Home Workout Set",
    "Pre-Workout Warmup",
    "Hydration Tracker",
    "Fitness Habit Tracker",
    "HIIT Timer \u2014 10-minute",
    "HIIT Timer \u2014 20-minute",
    "HIIT Timer \u2014 Beginner",
    "HIIT Timer \u2014 Intermediate",
    "HIIT Timer \u2014 No equipment",
    "HIIT Timer \u2014 Home",
    "HIIT Timer \u2014 Gym",
    "HIIT Timer \u2014 Low impact",
    "HIIT Timer \u2014 High intensity",
    "HIIT Timer \u2014 Recovery-focused",
    "Jump Rope \u2014 10-minute",
    "Jump Rope \u2014 20-minute",
    "Jump Rope \u2014 Beginner",
    "Jump Rope \u2014 Intermediate",
    "Jump Rope \u2014 No equipment",
    "Jump Rope \u2014 Home",
    "Jump Rope \u2014 Gym",
    "Jump Rope \u2014 Low impact",
    "Jump Rope \u2014 High intensity",
    "Jump Rope \u2014 Recovery-focused",
    "Resistance Bands \u2014 10-minute",
    "Resistance Bands \u2014 20-minute",
    "Resistance Bands \u2014 Beginner",
    "Resistance Bands \u2014 Intermediate",
    "Resistance Bands \u2014 No equipment",
    "Resistance Bands \u2014 Home",
    "Resistance Bands \u2014 Gym",
    "Resistance Bands \u2014 Low impact",
    "Resistance Bands \u2014 High intensity",
    "Resistance Bands \u2014 Recovery-focused"
  ],
  "Creative": [
    "Writing Prompts",
    "Sketch Set",
    "Watercolor Kit",
    "AI Art Tool",
    "Design Micro-Course",
    "Photo Challenge List",
    "Storytelling Template",
    "Idea Journal",
    "Collage Kit",
    "Creative Timer",
    "Poetry Prompt Deck",
    "Color Palette Generator",
    "Moodboard Starter",
    "Beginner Animation Lesson",
    "DIY Craft Box",
    "Zine-Making Kit",
    "Songwriting Prompts",
    "Creative Warmup Routine",
    "Logo Practice Set",
    "Typography Mini-Lesson",
    "Writing Prompts \u2014 Beginner",
    "Writing Prompts \u2014 15-minute",
    "Writing Prompts \u2014 30-minute",
    "Writing Prompts \u2014 Daily",
    "Writing Prompts \u2014 Weekend",
    "Writing Prompts \u2014 Minimal tools",
    "Writing Prompts \u2014 Digital",
    "Writing Prompts \u2014 Analog",
    "Writing Prompts \u2014 For creators",
    "Writing Prompts \u2014 For fun",
    "Sketch Set \u2014 Beginner",
    "Sketch Set \u2014 15-minute",
    "Sketch Set \u2014 30-minute",
    "Sketch Set \u2014 Daily",
    "Sketch Set \u2014 Weekend",
    "Sketch Set \u2014 Minimal tools",
    "Sketch Set \u2014 Digital",
    "Sketch Set \u2014 Analog",
    "Sketch Set \u2014 For creators",
    "Sketch Set \u2014 For fun",
    "Watercolor Kit \u2014 Beginner",
    "Watercolor Kit \u2014 15-minute",
    "Watercolor Kit \u2014 30-minute",
    "Watercolor Kit \u2014 Daily",
    "Watercolor Kit \u2014 Weekend",
    "Watercolor Kit \u2014 Minimal tools",
    "Watercolor Kit \u2014 Digital",
    "Watercolor Kit \u2014 Analog",
    "Watercolor Kit \u2014 For creators",
    "Watercolor Kit \u2014 For fun"
  ],
  "Tired": [
    "Sleep Sounds",
    "Evening Stretch",
    "Warm Eye Mask",
    "Neck Pillow",
    "Blue Light Glasses",
    "Power Nap Routine",
    "Screen-Off Ritual",
    "Early Bedtime Plan",
    "Calm Audiobook",
    "Low-Light Lamp",
    "Foot Soak Routine",
    "Rest Day Checklist",
    "Morning Sunlight Habit",
    "Sleep Mask",
    "Gentle Yoga",
    "Breathing for Sleep",
    "Wind-Down Tea",
    "White Noise Machine",
    "Light Reading List",
    "Relaxing Playlist",
    "Sleep Sounds \u2014 10-minute",
    "Sleep Sounds \u2014 15-minute",
    "Sleep Sounds \u2014 No screen",
    "Sleep Sounds \u2014 Travel",
    "Sleep Sounds \u2014 Home",
    "Sleep Sounds \u2014 Budget",
    "Sleep Sounds \u2014 Premium",
    "Sleep Sounds \u2014 Quick reset",
    "Sleep Sounds \u2014 Deep rest",
    "Sleep Sounds \u2014 Gentle",
    "Evening Stretch \u2014 10-minute",
    "Evening Stretch \u2014 15-minute",
    "Evening Stretch \u2014 No screen",
    "Evening Stretch \u2014 Travel",
    "Evening Stretch \u2014 Home",
    "Evening Stretch \u2014 Budget",
    "Evening Stretch \u2014 Premium",
    "Evening Stretch \u2014 Quick reset",
    "Evening Stretch \u2014 Deep rest",
    "Evening Stretch \u2014 Gentle",
    "Warm Eye Mask \u2014 10-minute",
    "Warm Eye Mask \u2014 15-minute",
    "Warm Eye Mask \u2014 No screen",
    "Warm Eye Mask \u2014 Travel",
    "Warm Eye Mask \u2014 Home",
    "Warm Eye Mask \u2014 Budget",
    "Warm Eye Mask \u2014 Premium",
    "Warm Eye Mask \u2014 Quick reset",
    "Warm Eye Mask \u2014 Deep rest",
    "Warm Eye Mask \u2014 Gentle"
  ]
};

  // localStorage keys
  const LS_FAV = "moodmarket_favorites_v2";
  const LS_ORDER = "moodmarket_order_v1";
  const LS_INDEX = "moodmarket_index_v1";

  function slugify(s){ return s.toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }

  // Toast
  const toastEl = document.getElementById("toast");
  let toastTimer = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ toastEl.style.display="none"; }, 1600);
  }

  function loadJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ return fallback; }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  // Favorites
  let favorites = loadJSON(LS_FAV, []); // {id, mood, title, link, img}
  function itemId(mood, title){ return mood + "::" + title.toLowerCase(); }

  function favCountUpdate(){
    document.getElementById("favCount").textContent = `(${favorites.length})`;
    const footerText = document.getElementById("favFooterText");
    if(footerText) footerText.textContent = `${favorites.length} saved`;
  }

  // --- Ordering system per mood: shuffle once, then take next batch (no repeats until exhausted) ---
  // order[mood] = array of indices 0..49
  let order = loadJSON(LS_ORDER, {});
  let idx   = loadJSON(LS_INDEX, {});

  function ensureOrder(mood){
    const n = CATALOG[mood].length;
    if(!order[mood] || order[mood].length !== n){
      order[mood] = Array.from({length:n}, (_,i)=>i);
      // Fisher‚ÄìYates shuffle
      for(let i=n-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [order[mood][i], order[mood][j]] = [order[mood][j], order[mood][i]];
      }
      idx[mood] = 0;
      saveJSON(LS_ORDER, order);
      saveJSON(LS_INDEX, idx);
    }
    if(typeof idx[mood] !== "number") idx[mood]=0;
  }

  function nextBatch(mood, k){
    ensureOrder(mood);
    const n = CATALOG[mood].length;
    const result = [];
    const usedTitles = new Set(); // extra safety: never duplicate within same page

    while(result.length < k){
      if(idx[mood] >= n){
        // reshuffle when exhausted
        order[mood] = Array.from({length:n}, (_,i)=>i);
        for(let i=n-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [order[mood][i], order[mood][j]] = [order[mood][j], order[mood][i]];
        }
        idx[mood] = 0;
      }
      const pickIndex = order[mood][idx[mood]++];
      const title = CATALOG[mood][pickIndex];
      const key = title.toLowerCase();
      if(usedTitles.has(key)) continue;
      usedTitles.add(key);
      result.push({ mood, title });
    }
    saveJSON(LS_ORDER, order);
    saveJSON(LS_INDEX, idx);
    return result;
  }

  // Images: Unsplash Source returns a photo for query.
  // If Unsplash is blocked in a region, it still won't be blank because we have a gradient fallback.
  function imageUrlFor(item){
    const q = encodeURIComponent(`${item.title} ${item.mood}`);
    // "source.unsplash.com" returns a random matching image; size chosen for 16:9
    return `https://source.unsplash.com/featured/800x450?${q}`;
  }

  function affiliateLinkFor(item){
    return AFFILIATE_BASE + encodeURIComponent(slugify(item.mood + "-" + item.title));
  }

  // Render
  const feedEl = document.getElementById("feed");
  const feedTitleEl = document.getElementById("feedTitle");
  let currentMood = "Stressed";

  function render(mood){
    currentMood = mood;
    feedTitleEl.textContent = `Recommended for: ${mood}`;
    feedEl.innerHTML = "";

    const batch = nextBatch(mood, CARDS_PER_REFRESH);

    for(const item of batch){
      const id = itemId(item.mood, item.title);
      const link = affiliateLinkFor(item);
      const img = imageUrlFor(item);
      const isFav = favorites.some(f=>f.id===id);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="thumb" src="${img}" alt="${item.title}" loading="lazy"
             onerror="this.style.display='none'; this.parentElement.querySelector('.thumbFallback').style.display='block';" />
        <div class="thumbFallback" style="display:none; width:100%; aspect-ratio:16/9; background:
          radial-gradient(700px 280px at 40% 0%, rgba(124,131,255,0.18), transparent 55%),
          radial-gradient(700px 280px at 70% 10%, rgba(45,212,191,0.14), transparent 60%),
          rgba(255,255,255,0.04);
          border-bottom: 1px solid rgba(255,255,255,0.08);"></div>

        <div class="card-inner">
          <span class="badge">${mood} pick</span>
          <h3>${item.title}</h3>
          <p>Tap ‚ÄúView / Buy‚Äù to test affiliate clicks. Use ‚òÖ to save.</p>
          <div class="actions">
            <button class="buy" type="button" data-link="${link}">View / Buy</button>
            <button class="iconbtn" type="button" title="Save" data-save="${id}" aria-label="Save">${isFav ? "‚òÖ" : "‚òÜ"}</button>
          </div>
        </div>
      `;

      card.querySelector(".buy").addEventListener("click", (e)=>{
        window.open(e.currentTarget.getAttribute("data-link"), "_blank");
      });

      card.querySelector(`[data-save="${id}"]`).addEventListener("click", (e)=>{
        const fidx = favorites.findIndex(f=>f.id===id);
        if(fidx>=0){
          favorites.splice(fidx,1);
          saveJSON(LS_FAV, favorites);
          e.currentTarget.textContent = "‚òÜ";
          toast("Removed from favorites");
        }else{
          favorites.push({ id, mood:item.mood, title:item.title, link, img });
          saveJSON(LS_FAV, favorites);
          e.currentTarget.textContent = "‚òÖ";
          toast("Saved to favorites");
        }
        favCountUpdate();
      });

      feedEl.appendChild(card);
    }
  }

  // Mood clicks always refresh (even same mood)
  document.querySelectorAll(".mood").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".mood").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      render(btn.dataset.mood);
    });
  });

  document.getElementById("shuffleBtn").addEventListener("click", ()=>{
    render(currentMood);
    toast("New suggestions loaded");
  });

  // Favorites modal
  const modal = document.getElementById("favModal");
  const backdrop = document.getElementById("modalBackdrop");
  const favGrid = document.getElementById("favGrid");

  function openFavorites(){
    backdrop.style.display = "block";
    modal.style.display = "block";
    renderFavoritesGrid();
  }
  function closeFavorites(){
    backdrop.style.display = "none";
    modal.style.display = "none";
  }

  function renderFavoritesGrid(){
    favGrid.innerHTML = "";
    if(favorites.length===0){
      favGrid.innerHTML = `<div style="grid-column: span 12; color: var(--muted); font-size: 13px; padding: 6px;">No favorites yet. Tap ‚òÜ on an item to save it.</div>`;
      favCountUpdate();
      return;
    }

    favorites.forEach(f=>{
      const card = document.createElement("div");
      card.className = "favCard";
      card.innerHTML = `
        <img class="thumb" src="${f.img}" alt="${f.title}" loading="lazy"
             onerror="this.style.display='none'; this.parentElement.querySelector('.thumbFallback').style.display='block';" />
        <div class="thumbFallback" style="display:none; width:100%; aspect-ratio:16/9; background:
          radial-gradient(700px 280px at 40% 0%, rgba(124,131,255,0.18), transparent 55%),
          radial-gradient(700px 280px at 70% 10%, rgba(45,212,191,0.14), transparent 60%),
          rgba(255,255,255,0.04);
          border-bottom: 1px solid rgba(255,255,255,0.08);"></div>

        <div class="favInner">
          <div class="favTitle">${f.title}</div>
          <div class="favDesc">${f.mood}</div>
          <div class="actions">
            <button class="buy" type="button">View / Buy</button>
            <button class="iconbtn danger" type="button" title="Remove" aria-label="Remove">‚úï</button>
          </div>
        </div>
      `;

      card.querySelector(".buy").addEventListener("click", ()=> window.open(f.link, "_blank"));
      card.querySelector(".iconbtn").addEventListener("click", ()=>{
        favorites = favorites.filter(x=>x.id!==f.id);
        saveJSON(LS_FAV, favorites);
        toast("Removed from favorites");
        favCountUpdate();
        renderFavoritesGrid();
      });

      favGrid.appendChild(card);
    });

    favCountUpdate();
  }

  document.getElementById("openFavorites").addEventListener("click", openFavorites);
  document.getElementById("closeFavorites").addEventListener("click", closeFavorites);
  document.getElementById("modalBackdrop").addEventListener("click", closeFavorites);

  document.getElementById("clearFavorites").addEventListener("click", ()=>{
    favorites = [];
    saveJSON(LS_FAV, favorites);
    toast("Favorites cleared");
    favCountUpdate();
    renderFavoritesGrid();
  });

  // Initial
  favCountUpdate();
  render("Stressed");
</script>
</body>
</html>